const API_BASE_URL="https://sillymaquina.vercel.app/api/v1";async function handleMessage(e,t,a){try{switch(e.action){case"captureScreen":await handleCaptureScreen(e,t,a);break;case"captureVisibleTab":try{a({success:!0,screenshot:await chrome.tabs.captureVisibleTab(null,{format:"png",quality:100})})}catch(e){console.error("Capture visible tab error:",e),a({success:!1,error:e.message})}break;case"processImage":await handleProcessImage(e,a);break;case"checkAuth":a({success:!0,isAuthenticated:!!await getStorageItem("token")});break;case"getCooldownStatus":a({success:!0,cooldown:await getCooldownStatus()});break;case"checkMaintenance":await handleCheckMaintenance(a);break;default:a({success:!1,error:"Ação desconhecida"})}}catch(e){console.error("Error in background:",e),a({success:!1,error:e.message})}}async function handleCaptureScreen(e,t,a){try{const e=await getStorageItem("settings")||getDefaultSettings();if("padrão"===(e.screenCaptureMode||"padrão")){const e=await chrome.tabs.captureVisibleTab(null,{format:"png",quality:100});a({success:!0,screenshot:e,mode:"padrão"})}else chrome.tabs.sendMessage(t.tab.id,{action:"captureFullPage"},(e=>{a(e)}))}catch(e){console.error("Capture error:",e),a({success:!1,error:e.message})}}async function handleProcessImage(e,t){try{const{imageData:a,modelId:o}=e,r=await getStorageItem("token"),s=await getStorageItem("settings")||getDefaultSettings();if(!r)throw new Error("Não autenticado");const n=await getStorageItem("user");let i=await getStorageItem("lastRequest");const c=n?.rateLimiter?.cooldownSeconds||120;if(i&&Date.now()-i>864e5&&(await setStorageItem("lastRequest",null),i=null),i){const e=(Date.now()-i)/1e3;if(e<c+1){const t=Math.ceil(c-e);throw console.warn(`CLIENT-SIDE COOLDOWN BLOCK: ${t}s remaining - REJECTING REQUEST`),console.warn(`LastRequest was at: ${new Date(i).toISOString()}`),console.warn(`Current time: ${(new Date).toISOString()}`),new Error(`Aguarde ${t} segundos antes de fazer outra requisição`)}}const l=Date.now();await setStorageItem("lastRequest",l);const u=a.split(",")[1],d=atob(u),g=[];for(let e=0;e<d.length;e++)g.push(d.charCodeAt(e));const m=new Blob([new Uint8Array(g)],{type:"image/png"}),h=new FormData;h.append("questionImage",m,"screenshot.png"),h.append("modelId",o),void 0!==s.temperature&&h.append("temperature",s.temperature);const w=await fetch(`${API_BASE_URL}/ai/process-image`,{method:"POST",headers:{Authorization:`Bearer ${r}`},body:h});if(!w.ok){if(401===w.status)throw await chrome.storage.local.clear(),chrome.tabs.query({},(e=>{e.forEach((e=>{chrome.tabs.sendMessage(e.id,{action:"forceLogout"}).catch((()=>{}))}))})),new Error("Sessão expirada. Faça login novamente.");const e=await w.json();throw new Error(e.error?.message||"Erro ao processar imagem")}const p=w.body.getReader(),S=new TextDecoder;let b="";for(;;){const{done:e,value:t}=await p.read();if(e)break;b+=S.decode(t,{stream:!0})}const y=/^Resposta:\s*.+/i,I=/^Inválida\/Insolúvel$/i.test(b.trim());y.test(b.trim())||I||(b="Inválida/Insolúvel"),await addToHistory({image:a,response:b,modelId:o,timestamp:Date.now()}),t({success:!0,result:b})}catch(e){console.error("Process image error:",e),t({success:!1,error:e.message})}}async function getCooldownStatus(){const e=await getStorageItem("user"),t=await getStorageItem("lastRequest"),a=e?.rateLimiter?.cooldownSeconds||120;if(!t)return{canRequest:!0,waitTime:0};const o=(Date.now()-t)/1e3,r=Math.max(0,Math.ceil(a-o));return{canRequest:0===r,waitTime:r,cooldownSeconds:a}}async function getStorageItem(e){return(await chrome.storage.local.get(e))[e]}async function setStorageItem(e,t){return chrome.storage.local.set({[e]:t})}async function addToHistory(e){try{const t=await getStorageItem("settings")||getDefaultSettings(),a=Math.min(t.historyLimit||15,15);if(0===a)return;const o=await getStorageItem("history")||[];o.unshift(e);const r=o.slice(0,a);try{await setStorageItem("history",r)}catch(e){if(!e.message||!e.message.includes("QUOTA"))throw e;{console.warn("Storage quota exceeded, reducing history to 10 items");const e=r.slice(0,10);await setStorageItem("history",e)}}}catch(e){console.error("Error adding to history:",e);try{await setStorageItem("history",[])}catch(e){console.error("Failed to clear history:",e)}}}function getDefaultSettings(){return{selectedModel:"gemini-2.5-flash-lite",temperature:.9,screenCaptureMode:"padrão",keybindSimple:"Alt+X",keybindPro:null,keybindProEnabled:!1,keybindModelSwitch:"Alt+M",keybindCaptureModeSwitch:null,answerExhibitionMode:"pageTitle",popupSize:300,popupOpacity:.95,popupDuration:10,titleCooldownDisplay:!0,titleAnswerDuration:15,titleShowAnalyzing:!0,buttonPosition:"bottomRight",buttonSize:50,buttonOpacity:.9,buttonIcon:"fa-robot",buttonSingleClick:!0,buttonDoubleClick:!0,buttonTooltip:!0,historyLimit:15}}async function handleCheckMaintenance(e){try{const t=await fetch(`${API_BASE_URL}/public/maintenance-status`);if(!t.ok)return void e({isUnderMaintenance:!1});const a=await t.json();e({isUnderMaintenance:a.isUnderMaintenance,active:a.active,upcoming:a.upcoming})}catch(t){console.error("Failed to check maintenance status:",t),e({isUnderMaintenance:!1})}}chrome.runtime.onInstalled.addListener((e=>{console.log("Extension installed/updated:",e.reason),"install"===e.reason&&chrome.storage.local.clear()})),chrome.runtime.onMessage.addListener(((e,t,a)=>(handleMessage(e,t,a),!0)));