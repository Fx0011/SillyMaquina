const API_BASE_URL="https://sillymaquina.vercel.app/api/v1",EXTENSION_VERSION="3.0.3";let currentUser=null,currentConfig=null,currentTab="dashboard",cachedMetrics=null,metricsLastFetched=null;const METRICS_CACHE_TTL=3e5;let maintenanceStatus=null;async function checkMaintenanceAndAuth(){try{const t=await fetch(`${API_BASE_URL}/public/maintenance-status`);if(t.ok&&(maintenanceStatus=await t.json(),maintenanceStatus.isUnderMaintenance))return void showMaintenanceScreen(maintenanceStatus.active);await checkVersionAndAuth()}catch(t){console.error("Failed to check maintenance status:",t),await checkVersionAndAuth()}}async function checkVersionAndAuth(){try{const t=await fetch(`${API_BASE_URL}/public/config`);if(!t.ok)throw new Error("Failed to load config from API");const e=await t.json();currentConfig=e,await chrome.storage.local.set({config:e});const{token:n,user:a}=await chrome.storage.local.get(["token","user"]);if(!n||!a)return console.log("Not authenticated"),void showLoginScreen();console.log("User authenticated"),currentUser=a;const{settings:s}=await chrome.storage.local.get(["settings"]);let i;s&&Object.keys(s).length>0?(i=mergeWithDefaults(s),currentUser.configurationSettings&&Object.keys(currentUser.configurationSettings).length>0&&(i={...i,...currentUser.configurationSettings})):i=currentUser.configurationSettings&&Object.keys(currentUser.configurationSettings).length>0?mergeWithDefaults(currentUser.configurationSettings):getDefaultSettings(),i.historyLimit>15&&(console.warn(`History limit (${i.historyLimit}) exceeds maximum, forcing to 15`),i.historyLimit=15),await chrome.storage.local.set({settings:i});if(!currentConfig.plans[a.plan.id])return console.error("Plan not found in config:",a.plan.id),alert(`Plano '${a.plan.id}' n√£o encontrado na configura√ß√£o. Contate o suporte.`),void showLoginScreen();let o=e.extensionInfo||e.extension;if(o&&o.minVersion){const t=compareVersions(EXTENSION_VERSION,o.minVersion);if("outdated"===t)return void showUpdateModal(o.updateLink);const e=document.getElementById("testBuildBadge");e&&e.remove(),"test"===t?showTestBuildBadge():console.log("Version is current - no badge needed")}updateUserDisplay(),showMainScreen()}catch(t){console.error("INIT ERROR:",t),console.error(t.stack),showLoginScreen()}}function mergeWithDefaults(t){return{...getDefaultSettings(),...t}}function showTestBuildBadge(){const t=document.getElementById("testBuildBadge");t&&t.remove();const e=document.getElementById("mainScreen").querySelector(".tokens-display"),n=document.createElement("div");n.id="testBuildBadge",n.className="test-build-badge",n.innerHTML='<i class="fas fa-flask"></i> Vers√£o de Teste',e.insertAdjacentElement("afterend",n)}function compareVersions(t,e){const n=t.split(".").map(Number),a=e.split(".").map(Number);for(let t=0;t<3;t++){if(n[t]>a[t])return"test";if(n[t]<a[t])return"outdated"}return"current"}function showUpdateModal(t){const e=document.getElementById("updateModal");document.getElementById("updateLink").href=t,e.classList.remove("hidden")}function updateUserDisplay(){if(!currentUser||!currentConfig)return;const t=document.getElementById("userIcon");currentUser.configurationSettings?.buttonIcon?t.innerHTML=`<i class="${currentUser.configurationSettings.buttonIcon}"></i>`:t.textContent=currentUser.username[0].toUpperCase(),document.getElementById("username").textContent=currentUser.username;const e=document.getElementById("planBadge"),n=currentConfig.plans[currentUser.plan.id];e.textContent=n?.name||currentUser.plan.id,updateTokensDisplay()}function updateTokensDisplay(){if(!currentUser||!currentConfig)return;const t=currentConfig.plans[currentUser.plan.id],e=currentUser.tokens.remaining,n=t.weeklyTokenAllocation,a=e/n*100;document.getElementById("tokensProgress").style.width=`${a}%`,document.getElementById("tokensText").textContent=`${formatNumber(e)} / ${formatNumber(n)}`}function showLoadingScreen(){document.getElementById("loadingScreen").classList.remove("hidden"),document.getElementById("loginScreen").classList.add("hidden"),document.getElementById("mainScreen").classList.add("hidden")}function showMainScreen(){document.getElementById("loadingScreen").classList.add("hidden"),document.getElementById("loginScreen").classList.add("hidden"),document.getElementById("mainScreen").classList.remove("hidden"),document.getElementById("maintenanceScreen").classList.add("hidden"),maintenanceStatus&&maintenanceStatus.upcoming?showMaintenanceBanner(maintenanceStatus.upcoming):hideMaintenanceBanner(),loadTab("dashboard")}function showMaintenanceScreen(t){document.getElementById("loadingScreen").classList.add("hidden"),document.getElementById("loginScreen").classList.add("hidden"),document.getElementById("mainScreen").classList.add("hidden"),document.getElementById("maintenanceScreen").classList.remove("hidden");const{title:e,message:n,startTime:a,endTime:s,affectedServices:i}=t;if(document.getElementById("maintenanceMessage").innerHTML=`<strong>${e}</strong><p>${n}</p>`,document.getElementById("maintenanceStart").textContent=formatDateTime(a),document.getElementById("maintenanceEnd").textContent=formatDateTime(s),updateMaintenanceTimeRemaining(s),i&&i.length>0){const t=document.getElementById("maintenanceServices");t.innerHTML=`\n\t\t\t<div class="services-title"><i class="fas fa-server"></i> Servi√ßos Afetados:</div>\n\t\t\t<ul class="services-list">\n\t\t\t\t${i.map((t=>`<li>${t}</li>`)).join("")}\n\t\t\t</ul>\n\t\t`,t.style.display="block"}}function showMaintenanceBanner(t){const e=document.getElementById("maintenanceBanner"),n=document.getElementById("bannerMaintenanceInfo"),a=(new Date(t.startTime),formatTimeUntil(t.timeUntilStart));n.innerHTML=`${t.title} - <span class="time-highlight">come√ßa em ${a}</span>`,e.classList.remove("hidden")}function hideMaintenanceBanner(){document.getElementById("maintenanceBanner").classList.add("hidden")}function showMaintenanceModal(t){const e=document.getElementById("maintenanceModal"),{title:n,message:a,startTime:s,endTime:i,timeUntilStart:o,affectedServices:r}=t;if(document.getElementById("modalMaintenanceTitle").textContent=n,document.getElementById("modalMaintenanceMessage").textContent=a,document.getElementById("modalMaintenanceStart").textContent=formatDateTime(s),document.getElementById("modalMaintenanceEnd").textContent=formatDateTime(i),o&&(document.getElementById("modalMaintenanceTimeUntil").textContent=formatTimeUntil(o)),r&&r.length>0){const t=document.getElementById("modalMaintenanceServices");t.innerHTML=`\n\t\t\t<div class="services-title"><i class="fas fa-server"></i> Servi√ßos Afetados:</div>\n\t\t\t<ul class="services-list">\n\t\t\t\t${r.map((t=>`<li>${t}</li>`)).join("")}\n\t\t\t</ul>\n\t\t`,t.style.display="block"}e.classList.remove("hidden")}function updateMaintenanceTimeRemaining(t){const e=()=>{const e=Date.now(),n=new Date(t).getTime()-e;document.getElementById("maintenanceRemaining").textContent=n<=0?"Finalizando...":formatTimeUntil(n)};e(),setInterval(e,6e4)}function formatDateTime(t){return new Date(t).toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}function formatTimeUntil(t){const e=Math.floor(t/36e5),n=Math.floor(t%36e5/6e4);if(e>24){const t=Math.floor(e/24);return`${t} dia${t>1?"s":""}`}return e>0?`${e}h ${n}min`:`${n} minuto${1!==n?"s":""}`}function showLoginScreen(){document.getElementById("loadingScreen").classList.add("hidden"),document.getElementById("loginScreen").classList.remove("hidden"),document.getElementById("mainScreen").classList.add("hidden"),document.getElementById("maintenanceScreen").classList.add("hidden")}async function loadTab(t){currentTab=t,document.querySelectorAll(".nav-tab").forEach((e=>{e.classList.toggle("active",e.dataset.tab===t)})),document.querySelectorAll(".tab-pane").forEach((t=>{t.classList.remove("active")}));const e=document.getElementById(`${t}Tab`);switch(e.classList.add("active"),t){case"dashboard":await loadDashboard(e,!1);break;case"settings":await loadSettings(e);break;case"history":await loadHistory(e);break;case"support":loadSupport(e)}}async function loadDashboard(t,e=!1){const n=Date.now();if(e||!(cachedMetrics&&metricsLastFetched&&n-metricsLastFetched<METRICS_CACHE_TTL)){t.innerHTML='<div class="loading"><div class="spinner"></div></div>';try{const e=await getStorageItem("token"),a=await fetch(`${API_BASE_URL}/users/me/metrics`,{headers:{Authorization:`Bearer ${e}`}});if(!a.ok){if(401===a.status)return await chrome.storage.local.clear(),void window.location.reload();throw new Error("Erro ao carregar m√©tricas")}const s=await a.json();cachedMetrics=s.metrics,metricsLastFetched=n,s.metrics.tokens&&(currentUser.tokens.remaining=s.metrics.tokens.remaining,await chrome.storage.local.set({user:currentUser}),updateTokensDisplay()),renderDashboard(t,cachedMetrics)}catch(e){console.error("Dashboard error:",e),t.innerHTML='\n      <div class="error-message show">\n        <i class="fas fa-exclamation-triangle"></i>\n        Erro ao carregar m√©tricas. Tente novamente.\n      </div>\n    '}}else renderDashboard(t,cachedMetrics)}function renderDashboard(t,e){const n=currentConfig.plans[currentUser.plan.id];t.innerHTML=`\n      <div class="dashboard">\n        \x3c!-- Add refresh button at top --\x3e\n        <div style="grid-column: 1 / -1; display: flex; justify-content: flex-end; margin-bottom: -10px;">\n          <button id="refreshDashboard" class="btn btn-sm" style="padding: 6px 12px;">\n            <i class="fas fa-sync-alt"></i> Atualizar\n          </button>\n        </div>\n        \n        <div class="dashboard-card user-card">\n          <div class="card-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">\n            <i class="fas fa-user"></i>\n          </div>\n          <div class="card-content">\n            <div class="card-label">Usu√°rio</div>\n            <div class="card-value">${currentUser.username}</div>\n            <div class="card-sublabel">${currentUser.email}</div>\n          </div>\n        </div>\n        \n        <div class="dashboard-card plan-card">\n          <div class="card-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">\n            <i class="fas fa-crown"></i>\n          </div>\n          <div class="card-content">\n            <div class="card-label">Plano Atual</div>\n            <div class="card-value">${n.name}</div>\n            ${currentUser.plan.endDate?`<div class="card-sublabel">Expira em ${e.plan.currentPlan.daysUntilExpiry} dias</div>`:'<div class="card-sublabel">Plano vital√≠cio</div>'}\n          </div>\n        </div>\n        \n        <div class="dashboard-card tokens-card">\n          <div class="card-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">\n            <i class="fas fa-coins"></i>\n          </div>\n          <div class="card-content">\n            <div class="card-label">Tokens Restantes</div>\n            <div class="card-value">${formatNumber(e.tokens.remaining)}</div>\n            <div class="card-sublabel">\n              de ${formatNumber(e.tokens.totalAllocation)}\n              (${e.tokens.percentageUsed.toFixed(1)}% usado)\n            </div>\n            <div class="progress-bar-small">\n              <div class="progress-fill" style="width: ${e.tokens.percentageUsed}%; background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);"></div>\n            </div>\n          </div>\n        </div>\n        \n        <div class="dashboard-card renewal-card">\n          <div class="card-icon" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">\n            <i class="fas fa-sync-alt"></i>\n          </div>\n          <div class="card-content">\n            <div class="card-label">Renova√ß√£o de Tokens</div>\n            <div class="card-value">${e.tokens.daysUntilRefresh} dias</div>\n            <div class="card-sublabel">${e.tokens.hoursUntilRefresh} horas restantes</div>\n          </div>\n        </div>\n        \n        <div class="dashboard-card requests-card">\n          <div class="card-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">\n            <i class="fas fa-chart-line"></i>\n          </div>\n          <div class="card-content">\n            <div class="card-label">Total de Requisi√ß√µes</div>\n            <div class="card-value">${formatNumber(e.usage.totalRequests)}</div>\n            <div class="card-sublabel">${formatNumber(e.usage.totalTokensSpent)} tokens gastos</div>\n          </div>\n        </div>\n        \n        <div class="dashboard-card average-card">\n          <div class="card-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">\n            <i class="fas fa-calculator"></i>\n          </div>\n          <div class="card-content">\n            <div class="card-label">M√©dia por Requisi√ß√£o</div>\n            <div class="card-value">${formatNumber(e.usage.averageTokensPerRequest)}</div>\n            <div class="card-sublabel">tokens</div>\n          </div>\n        </div>\n        \n        <div class="dashboard-card model-card">\n          <div class="card-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">\n            <i class="fas fa-brain"></i>\n          </div>\n          <div class="card-content">\n            <div class="card-label">Modelo Mais Usado</div>\n            <div class="card-value model-name">${e.usage.mostUsedModel.name}</div>\n            <div class="card-sublabel">${formatNumber(e.usage.mostUsedModel.usageCount)} usos</div>\n          </div>\n        </div>\n        \n        <div class="dashboard-card age-card">\n          <div class="card-icon" style="background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);">\n            <i class="fas fa-calendar-alt"></i>\n          </div>\n          <div class="card-content">\n            <div class="card-label">Idade da Conta</div>\n            <div class="card-value">${e.account.accountAgeDays}</div>\n            <div class="card-sublabel">dias</div>\n          </div>\n        </div>\n        \n        <div class="dashboard-section">\n          <h3><i class="fas fa-chart-pie"></i> Uso por Modelo</h3>\n          <div class="chart-container">\n            ${createModelUsageChart(e.usage.byModel)}\n          </div>\n        </div>\n        \n        <div class="dashboard-section">\n          <h3><i class="fas fa-table"></i> Detalhes por Modelo</h3>\n          <div class="model-table">\n            ${createModelTable(e.usage.byModel)}\n          </div>\n        </div>\n        \n        <div class="dashboard-section">\n          <h3><i class="fas fa-clock"></i> Informa√ß√µes de Rate Limit</h3>\n          <div class="rate-limiter-info">\n            <div class="info-item">\n              <span class="info-label">Cooldown:</span>\n              <span class="info-value">${e.rateLimiter.cooldownSeconds} segundos</span>\n            </div>\n            <div class="info-item">\n              <span class="info-label">Pode fazer requisi√ß√£o:</span>\n              <span class="info-value ${e.rateLimiter.canMakeRequest?"text-success":"text-danger"}">\n                ${e.rateLimiter.canMakeRequest?'<i class="fas fa-check"></i> Sim':`<i class="fas fa-times"></i> Aguarde ${e.rateLimiter.secondsUntilNextRequest}s`}\n              </span>\n            </div>\n          </div>\n        </div>\n      </div>\n    `,t.querySelector("#refreshDashboard")?.addEventListener("click",(async()=>{const e=t.querySelector("#refreshDashboard"),n=e.querySelector("i");e.disabled=!0,n.classList.add("fa-spin"),await loadDashboard(t,!0),e.disabled=!1,n.classList.remove("fa-spin"),showToast("Dashboard atualizado!","success")}))}function createModelUsageChart(t){const e=Object.entries(t);if(0===e.length)return'<div class="empty-chart">Nenhum dado dispon√≠vel ainda</div>';const n=e.reduce(((t,[,e])=>t+e.totalUsages),0),a=Math.max(...e.map((([,t])=>t.totalUsages)));return`\n    <div class="bar-chart">\n      ${e.map((([t,e])=>{const s=currentConfig.models[t],i=e.totalUsages/a*100,o=(e.totalUsages/n*100).toFixed(1);return`\n          <div class="chart-bar-item">\n            <div class="chart-label">\n              <span class="chart-model-name">${s.name}</span>\n              <span class="chart-value">${formatNumber(e.totalUsages)} (${o}%)</span>\n            </div>\n            <div class="chart-bar">\n              <div class="chart-bar-fill" style="width: ${i}%"></div>\n            </div>\n          </div>\n        `})).join("")}\n    </div>\n  `}function createModelTable(t){const e=Object.entries(t);return 0===e.length?'<div class="empty-table">Nenhum dado dispon√≠vel ainda</div>':`\n    <table class="data-table">\n      <thead>\n        <tr>\n          <th>Modelo</th>\n          <th>Usos</th>\n          <th>Custo/Uso</th>\n          <th>Total Gasto</th>\n        </tr>\n      </thead>\n      <tbody>\n        ${e.map((([t,e])=>{const n=currentConfig.models[t];return`\n            <tr>\n              <td>\n                <div class="model-cell">\n                  <strong>${n.name}</strong>\n                  <small>${n.description}</small>\n                </div>\n              </td>\n              <td>${formatNumber(e.totalUsages)}</td>\n              <td>${formatNumber(e.tokenCost)}</td>\n              <td><strong>${formatNumber(e.tokensSpent)}</strong></td>\n            </tr>\n          `})).join("")}\n      </tbody>\n    </table>\n  `}async function loadSettings(t){try{let e;if(e=currentUser.configurationSettings?mergeWithDefaults(currentUser.configurationSettings):await getStorageItem("settings")||getDefaultSettings(),!currentUser)throw new Error("currentUser is null");if(!currentConfig)throw new Error("currentConfig is null");const n=currentUser.plan.id,a=currentConfig.plans[n];if(!a)throw new Error(`Plan '${n}' not found in config`);const s=a.modelsAllowed;if(!s)throw new Error("BACKEND ERROR: 'modelsAllowed' field is missing from plan config. The backend is not sending this field!");if(!Array.isArray(s))throw new Error("BACKEND ERROR: 'modelsAllowed' is not an array. Got: "+typeof s);if(0===s.length)throw new Error(`CONFIG ERROR: 'modelsAllowed' array is empty for plan '${n}'`);const i=s.map((t=>{const n=currentConfig.models[t];return n?{id:t,name:n.name,cost:n.tokenCost,selected:e.selectedModel===t}:(console.warn(`‚ö†Ô∏è Model '${t}' not found in config.models`),null)})).filter((t=>null!==t)).sort(((t,e)=>t.cost-e.cost));if(0===i.length)throw new Error("No valid models found after filtering");const o=i.map((t=>`<option value="${t.id}" ${t.selected?"selected":""}>${t.name} (${formatNumber(t.cost)} tokens)</option>`)).join("");t.innerHTML=`\n\t\t<div class="settings">\n\t\t  <div class="settings-section">\n\t\t\t<h3><i class="fas fa-brain"></i> Modelo e IA</h3>\n\t\t\t\n\t\t\t<div class="setting-item">\n\t\t\t  <label>Modelo Padr√£o</label>\n\t\t\t  <select id="selectedModel" class="setting-select">\n\t\t\t\t${o}\n\t\t\t  </select>\n\t\t\t  <small>Modelo usado para processar imagens</small>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div class="setting-item">\n\t\t\t  <label>Temperatura</label>\n\t\t\t  <div class="slider-container">\n\t\t\t\t<input type="range" id="temperature" min="0" max="1.5" step="0.1" value="${e.temperature}" class="setting-slider">\n\t\t\t\t<span class="slider-value">${e.temperature}</span>\n\t\t\t  </div>\n\t\t\t  <small>Controla a criatividade do modelo (0 = preciso, 1.5 = criativo)</small>\n\t\t\t</div>\n\t\t  </div>\n\t\t  \n\t\t  <div class="settings-section">\n\t\t\t<h3><i class="fas fa-camera"></i> Captura de Tela</h3>\n\t\t\t\n\t\t\t<div class="setting-item">\n\t\t\t  <label>Modo de Captura</label>\n\t\t\t  <select id="screenCaptureMode" class="setting-select" ${checkPlanAccess(n,["pro","admin"])?"":"disabled"}>\n\t\t\t\t<option value="padr√£o" ${"padr√£o"===e.screenCaptureMode?"selected":""}>Padr√£o</option>\n\t\t\t\t<option value="total" ${"total"===e.screenCaptureMode?"selected":""}>\n\t\t\t\t  Total (P√°gina Completa) ${checkPlanAccess(n,["pro","admin"])?"":"üîí"}\n\t\t\t\t</option>\n\t\t\t  </select>\n\t\t\t  ${checkPlanAccess(n,["pro","admin"])?"<small>Padr√£o captura √°rea vis√≠vel, Total captura p√°gina completa</small>":'<small class="plan-restriction">Captura total dispon√≠vel apenas para planos Pro e Admin</small>'}\n\t\t\t</div>\n\t\t  </div>\n\t\t  \n\t\t  <div class="settings-section">\n\t\t\t<h3><i class="fas fa-keyboard"></i> Atalhos de Teclado</h3>\n\t\t\t\n\t\t\t<div class="setting-item">\n\t\t\t  <div class="keybind-toggle">\n\t\t\t\t<label>\n\t\t\t\t  <input type="radio" name="keybindMode" value="simple" ${e.keybindProEnabled?"":"checked"}>\n\t\t\t\t  Keybind Simples\n\t\t\t\t</label>\n\t\t\t\t<label>\n\t\t\t\t  <input type="radio" name="keybindMode" value="pro" ${e.keybindProEnabled?"checked":""} ${checkPlanAccess(n,["pro","admin"])?"":"disabled"}>\n\t\t\t\t  Keybind Pro ${checkPlanAccess(n,["pro","admin"])?"":"üîí"}\n\t\t\t\t</label>\n\t\t\t  </div>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div class="setting-item" id="simpleKeybindSetting" ${e.keybindProEnabled?'style="display:none"':""}>\n\t\t\t  <label>Atalho Simples (Capturar)</label>\n\t\t\t  <div class="keybind-recorder">\n\t\t\t\t<input type="text" id="keybindSimple" value="${e.keybindSimple}" class="setting-input keybind-input" readonly placeholder="Clique e pressione as teclas">\n\t\t\t\t<button type="button" class="btn btn-sm keybind-clear" data-target="keybindSimple">\n\t\t\t\t  <i class="fas fa-times"></i>\n\t\t\t\t</button>\n\t\t\t  </div>\n\t\t\t  <small>Deve conter Ctrl, Alt ou Shift + uma tecla (ex: Alt+X, Ctrl+A, Ctrl+Alt+Z)</small>\n\t\t\t  <small id="keybindSimpleError" class="plan-restriction" style="display:none;"></small>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div class="setting-item" id="proKeybindSetting" ${e.keybindProEnabled?"":'style="display:none"'}>\n\t\t\t  <label>Atalho Pro (Capturar)</label>\n\t\t\t  <div class="keybind-recorder">\n\t\t\t\t<input type="text" id="keybindPro" value="${e.keybindPro||""}" class="setting-input keybind-input" readonly placeholder="Clique para configurar (tecla √∫nica ou clique do meio)">\n\t\t\t\t<button type="button" class="btn btn-sm keybind-clear" data-target="keybindPro">\n\t\t\t\t  <i class="fas fa-times"></i>\n\t\t\t\t</button>\n\t\t\t  </div>\n\t\t\t  <small>Teclas individuais: Letras (A-Z), N√∫meros (0-9), Setas (‚Üë‚Üì‚Üê‚Üí), F-keys (F1-F12), ou clique do MEIO do mouse</small>\n\t\t\t  <small id="keybindProError" class="plan-restriction" style="display:none;"></small>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div class="setting-item" ${checkPlanAccess(n,["basic","pro","admin"])?"":'style="opacity:0.5"'}>\n\t\t\t  <label>Atalho para Trocar Modelo</label>\n\t\t\t  <div class="keybind-recorder">\n\t\t\t\t<input type="text" id="keybindModelSwitch" value="${e.keybindModelSwitch||""}" class="setting-input keybind-input" ${checkPlanAccess(n,["basic","pro","admin"])?"readonly":"disabled"} placeholder="Clique e pressione as teclas">\n\t\t\t\t<button type="button" class="btn btn-sm keybind-clear" data-target="keybindModelSwitch" ${checkPlanAccess(n,["basic","pro","admin"])?"":"disabled"}>\n\t\t\t\t  <i class="fas fa-times"></i>\n\t\t\t\t</button>\n\t\t\t  </div>\n\t\t\t  ${checkPlanAccess(n,["basic","pro","admin"])?"<small>Deve conter Ctrl, Alt ou Shift + uma tecla</small>":'<small class="plan-restriction">Dispon√≠vel a partir do plano Basic</small>'}\n\t\t\t  <small id="keybindModelSwitchError" class="plan-restriction" style="display:none;"></small>\n\t\t\t</div>\n\n\t\t\t<div class="setting-item" ${checkPlanAccess(n,["pro","admin"])?"":'style="opacity:0.5"'}>\n\t\t\t  <label>Atalho para Trocar Modo de Captura</label>\n\t\t\t  <div class="keybind-recorder">\n\t\t\t\t<input type="text" id="keybindCaptureModeSwitch" value="${e.keybindCaptureModeSwitch||""}" class="setting-input keybind-input" ${checkPlanAccess(n,["pro","admin"])?"readonly":"disabled"} placeholder="Clique e pressione as teclas">\n\t\t\t\t<button type="button" class="btn btn-sm keybind-clear" data-target="keybindCaptureModeSwitch" ${checkPlanAccess(n,["pro","admin"])?"":"disabled"}>\n\t\t\t\t  <i class="fas fa-times"></i>\n\t\t\t\t</button>\n\t\t\t  </div>\n\t\t\t  ${checkPlanAccess(n,["pro","admin"])?"<small>Deve usar apenas Alt + uma tecla (ex: Alt+C)</small>":'<small class="plan-restriction">Dispon√≠vel apenas para plano Pro</small>'}\n\t\t\t  <small id="keybindCaptureModeError" class="plan-restriction" style="display:none;"></small>\n\t\t\t</div>\n\t\t  </div>\n\t\t  \n\t\t  <div class="settings-section">\n\t\t\t<h3><i class="fas fa-eye"></i> Exibi√ß√£o de Resposta</h3>\n\t\t\t\n\t\t\t<div class="setting-item">\n\t\t\t  <label>Modo de Exibi√ß√£o</label>\n\t\t\t  <select id="answerExhibitionMode" class="setting-select">\n\t\t\t\t<option value="smallPopup" ${"smallPopup"===e.answerExhibitionMode?"selected":""}>Popup Pequeno</option>\n\t\t\t\t<option value="pageTitle" ${"pageTitle"===e.answerExhibitionMode?"selected":""}>T√≠tulo da P√°gina</option>\n\t\t\t  </select>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div id="popupSettings" ${"smallPopup"!==e.answerExhibitionMode?'style="display:none"':""}>\n\t\t\t  <div class="setting-item">\n\t\t\t\t<label>Tamanho do Popup</label>\n\t\t\t\t<div class="slider-container">\n\t\t\t\t  <input type="range" id="popupSize" min="200" max="800" step="50" value="${e.popupSize}" class="setting-slider">\n\t\t\t\t  <span class="slider-value">${e.popupSize}px</span>\n\t\t\t\t</div>\n\t\t\t  </div>\n\t\t\t  \n\t\t\t  <div class="setting-item">\n\t\t\t\t<label>Opacidade do Popup</label>\n\t\t\t\t<div class="slider-container">\n\t\t\t\t  <input type="range" id="popupOpacity" min="0.1" max="1" step="0.05" value="${e.popupOpacity}" class="setting-slider">\n\t\t\t\t  <span class="slider-value">${Math.round(100*e.popupOpacity)}%</span>\n\t\t\t\t</div>\n\t\t\t  </div>\n\t\t\t  \n\t\t\t  <div class="setting-item">\n\t\t\t\t<label>Dura√ß√£o (segundos)</label>\n\t\t\t\t<input type="number" id="popupDuration" min="0" max="60" value="${e.popupDuration}" class="setting-input">\n\t\t\t\t<small>0 = permanente at√© clique</small>\n\t\t\t  </div>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div id="titleSettings" ${"pageTitle"!==e.answerExhibitionMode?'style="display:none"':""}>\n\t\t\t  <div class="setting-item">\n\t\t\t\t<label>\n\t\t\t\t  <input type="checkbox" id="titleCooldownDisplay" ${e.titleCooldownDisplay?"checked":""}>\n\t\t\t\t  Mostrar Cooldown no T√≠tulo\n\t\t\t\t</label>\n\t\t\t  </div>\n\t\t\t  \n\t\t\t  <div class="setting-item">\n\t\t\t\t<label>Dura√ß√£o da Resposta (segundos)</label>\n\t\t\t\t<input type="number" id="titleAnswerDuration" min="1" max="120" value="${e.titleAnswerDuration}" class="setting-input">\n\t\t\t  </div>\n\t\t\t  \n\t\t\t  <div class="setting-item">\n\t\t\t\t<label>\n\t\t\t\t  <input type="checkbox" id="titleShowAnalyzing" ${e.titleShowAnalyzing?"checked":""}>\n\t\t\t\t  Mostrar "Analisando..." no T√≠tulo\n\t\t\t\t</label>\n\t\t\t  </div>\n\t\t\t</div>\n\t\t  </div>\n\t\t  \n\t\t  <div class="settings-section">\n\t\t\t<h3><i class="fas fa-hand-pointer"></i> Bot√£o Flutuante</h3>\n\t\t\t\n\t\t\t<div class="setting-item">\n\t\t\t  <label>Posi√ß√£o</label>\n\t\t\t  <select id="buttonPosition" class="setting-select">\n\t\t\t\t<option value="bottomRight" ${"bottomRight"===e.buttonPosition?"selected":""}>Inferior Direita</option>\n\t\t\t\t<option value="bottomLeft" ${"bottomLeft"===e.buttonPosition?"selected":""}>Inferior Esquerda</option>\n\t\t\t\t<option value="hidden" ${"hidden"===e.buttonPosition?"selected":""}>Oculto</option>\n\t\t\t  </select>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div class="setting-item">\n\t\t\t  <label>Tamanho</label>\n\t\t\t  <div class="slider-container">\n\t\t\t\t<input type="range" id="buttonSize" min="20" max="80" step="5" value="${e.buttonSize}" class="setting-slider">\n\t\t\t\t<span class="slider-value">${e.buttonSize}px</span>\n\t\t\t  </div>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div class="setting-item">\n\t\t\t  <label>Opacidade</label>\n\t\t\t  <div class="slider-container">\n\t\t\t\t<input type="range" id="buttonOpacity" min="0.1" max="1" step="0.05" value="${e.buttonOpacity}" class="setting-slider">\n\t\t\t\t<span class="slider-value">${Math.round(100*e.buttonOpacity)}%</span>\n\t\t\t  </div>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div class="setting-item">\n\t\t\t  <label>√çcone</label>\n\t\t\t  <input type="text" id="buttonIcon" value="${e.buttonIcon}" class="setting-input" placeholder="fa-solid fa-robot">\n\t\t\t  <small>C√≥digo Font Awesome (ex: fa-solid fa-robot, fa-solid fa-brain)</small>\n\t\t\t  <a href="https://sillymaquina.netlify.app/icons" target="_blank" class="btn btn-sm">\n\t\t\t\t<i class="fas fa-icons"></i> Escolher √çcone\n\t\t\t  </a>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div class="setting-item">\n\t\t\t  <label>A√ß√µes do Bot√£o</label>\n\t\t\t  <label>\n\t\t\t\t<input type="checkbox" id="buttonSingleClick" ${e.buttonSingleClick?"checked":""}>\n\t\t\t\tClique Simples: Capturar Tela\n\t\t\t  </label>\n\t\t\t  <label>\n\t\t\t\t<input type="checkbox" id="buttonDoubleClick" ${e.buttonDoubleClick?"checked":""}>\n\t\t\t\tClique Duplo: Trocar Modelo\n\t\t\t  </label>\n\t\t\t</div>\n\t\t\t\n\t\t\t<div class="setting-item">\n\t\t\t  <label>\n\t\t\t\t<input type="checkbox" id="buttonTooltip" ${e.buttonTooltip?"checked":""}>\n\t\t\t\tMostrar Tooltip ao Passar o Mouse\n\t\t\t  </label>\n\t\t\t</div>\n\t\t  </div>\n\t\t  \n\t\t  <div class="settings-section">\n\t\t\t<h3><i class="fas fa-history"></i> Hist√≥rico</h3>\n\t\t\t\n\t\t\t<div class="setting-item">\n\t\t\t  <label>Limite de Itens</label>\n\t\t\t  <input type="number" id="historyLimit" min="0" max="15" value="${e.historyLimit}" class="setting-input">\n\t\t\t  <small>0 = desabilitar hist√≥rico (m√°ximo 15 para prevenir erros de storage)</small>\n\t\t\t</div>\n\t\t  </div>\n\t\t  \n\t\t  <div class="settings-actions">\n\t\t\t<button id="saveSettings" class="btn btn-primary">\n\t\t\t  <i class="fas fa-save"></i> Salvar Configura√ß√µes\n\t\t\t</button>\n\t\t\t<button id="resetSettings" class="btn btn-secondary">\n\t\t\t  <i class="fas fa-undo"></i> Restaurar Padr√µes\n\t\t\t</button>\n\t\t  </div>\n\t\t</div>\n\t  `,setupSettingsHandlers(t)}catch(e){console.error("SETTINGS LOAD ERROR:",e),console.error(e.stack),t.innerHTML=`\n\t\t\t<div class="error-message show">\n\t\t\t\t<i class="fas fa-exclamation-triangle"></i>\n\t\t\t\t<strong>Erro ao carregar configura√ß√µes</strong><br>\n\t\t\t\t<small>${e.message}</small><br><br>\n\t\t\t\t<button class="btn btn-primary" onclick="window.location.reload()">Recarregar Extens√£o</button>\n\t\t\t</div>\n\t\t`}}function setupSettingsHandlers(t){t.querySelectorAll('input[name="keybindMode"]').forEach((e=>{e.addEventListener("change",(e=>{const n="pro"===e.target.value;t.querySelector("#simpleKeybindSetting").style.display=n?"none":"block",t.querySelector("#proKeybindSetting").style.display=n?"block":"none"}))})),t.querySelector("#answerExhibitionMode").addEventListener("change",(e=>{const n=e.target.value;t.querySelector("#popupSettings").style.display="smallPopup"===n?"block":"none",t.querySelector("#titleSettings").style.display="pageTitle"===n?"block":"none"})),t.querySelectorAll(".setting-slider").forEach((t=>{t.addEventListener("input",(t=>{const e=t.target.nextElementSibling;let n=t.target.value;"temperature"===t.target.id?n=parseFloat(n).toFixed(1):t.target.id.includes("Opacity")?n=Math.round(100*parseFloat(n))+"%":n+=t.target.id.includes("Size")?"px":"",e.textContent=n}))})),setupKeybindRecorders(t),t.querySelector("#saveSettings").addEventListener("click",(async()=>{await saveSettings(t)})),t.querySelector("#resetSettings").addEventListener("click",(async()=>{confirm("Tem certeza que deseja restaurar as configura√ß√µes padr√£o?")&&(await chrome.storage.local.set({settings:getDefaultSettings()}),await loadSettings(t),showToast("Configura√ß√µes restauradas!","success"))}))}function setupKeybindRecorders(t){t.querySelectorAll(".keybind-input").forEach((e=>{e.disabled||e.addEventListener("click",(function(){this.value="Pressione as teclas...",this.classList.add("recording");const e=t.querySelector(`#${this.id}Error`);e&&(e.style.display="none");const n="keybindPro"===this.id,a="keybindSimple"===this.id||"keybindModelSwitch"===this.id,s="keybindCaptureModeSwitch"===this.id,i=t=>{n&&1===t.button&&(t.preventDefault(),this.value="MiddleMouse",this.classList.remove("recording"),r())},o=t=>{t.preventDefault(),t.stopPropagation();let i="";const o=[];t.ctrlKey&&o.push("Ctrl"),t.altKey&&o.push("Alt"),t.shiftKey&&o.push("Shift");let l=t.key;const c={ArrowUp:"ArrowUp",ArrowDown:"ArrowDown",ArrowLeft:"ArrowLeft",ArrowRight:"ArrowRight"," ":"Space",Enter:"Enter",Tab:"Tab",Escape:"Escape",Backspace:"Backspace",Delete:"Delete",Home:"Home",End:"End",PageUp:"PageUp",PageDown:"PageDown",Insert:"Insert",Pause:"Pause",PrintScreen:"Print"};/^F\d+$/.test(l)&&(c[l]=l);for(const[t,e]of Object.entries(c))if(l===t){l=e;break}if(1!==l.length||/^[A-Za-z0-9]$/.test(l)||(l=l.toUpperCase()),s){if(1!==o.length||"Alt"!==o[0])return e&&(e.textContent="Use apenas Alt + uma tecla (ex: Alt+C)",e.style.display="block"),this.value="",this.classList.remove("recording"),void r();if("Control"===l||"Alt"===l||"Shift"===l)return void(e&&(e.textContent="Adicione uma tecla al√©m do Alt",e.style.display="block"));if(!/^[A-Za-z0-9]$/.test(l))return e&&(e.textContent="Use apenas letras (A-Z) ou n√∫meros (0-9)",e.style.display="block"),this.value="",this.classList.remove("recording"),void r();i=`Alt+${l}`}else if(a){if(0===o.length)return e&&(e.textContent="Deve conter Alt, Ctrl ou Ctrl+Alt + uma tecla",e.style.display="block"),this.value="",this.classList.remove("recording"),void r();if("Control"===l||"Alt"===l||"Shift"===l)return void(e&&(e.textContent="Adicione uma tecla al√©m dos modificadores",e.style.display="block"));let t=!1;if(1!==o.length||"Alt"!==o[0]&&"Ctrl"!==o[0]?2===o.length&&o.includes("Ctrl")&&o.includes("Alt")&&(t=!0):t=!0,!t)return e&&(e.textContent="Use apenas Alt, Ctrl ou Ctrl+Alt (n√£o use Shift)",e.style.display="block"),this.value="",this.classList.remove("recording"),void r();if(!/^[A-Za-z0-9]$/.test(l))return e&&(e.textContent="Use apenas letras (A-Z) ou n√∫meros (0-9)",e.style.display="block"),this.value="",this.classList.remove("recording"),void r();o.includes("Ctrl")&&o.includes("Alt")?i=`Ctrl+Alt+${l}`:o.includes("Ctrl")?i=`Ctrl+${l}`:o.includes("Alt")&&(i=`Alt+${l}`)}else if(n){if(o.length>0)return e&&(e.textContent="Modo Pro n√£o permite modificadores (Ctrl/Alt/Shift)",e.style.display="block"),this.value="",this.classList.remove("recording"),void r();if("Control"===l||"Alt"===l||"Shift"===l)return;i=l}this.value=i,this.classList.remove("recording"),r()},r=()=>{document.removeEventListener("keydown",o,!0),document.removeEventListener("mousedown",i,!0)};document.addEventListener("keydown",o,!0),n&&document.addEventListener("mousedown",i,!0),setTimeout((()=>{this.classList.contains("recording")&&(this.value="",this.classList.remove("recording"),r())}),1e4)}))})),t.querySelectorAll(".keybind-clear").forEach((e=>{e.addEventListener("click",(function(e){e.preventDefault();const n=this.dataset.target,a=t.querySelector(`#${n}`);if(a){a.value="";const e=t.querySelector(`#${n}Error`);e&&(e.style.display="none")}}))}))}async function saveSettings(t){const e=t.querySelector("#saveSettings");e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Salvando...';try{const e=currentUser.plan.id,n=currentConfig.plans[e],a={selectedModel:t.querySelector("#selectedModel").value,temperature:parseFloat(t.querySelector("#temperature").value),screenCaptureMode:t.querySelector("#screenCaptureMode").value,keybindSimple:t.querySelector("#keybindSimple").value,keybindPro:t.querySelector("#keybindPro").value||null,keybindProEnabled:"pro"===t.querySelector('input[name="keybindMode"]:checked').value,keybindModelSwitch:checkPlanAccess(e,["basic","pro","admin"])&&t.querySelector("#keybindModelSwitch").value||null,keybindCaptureModeSwitch:checkPlanAccess(e,["pro","admin"])&&t.querySelector("#keybindCaptureModeSwitch").value||null,answerExhibitionMode:t.querySelector("#answerExhibitionMode").value,popupSize:parseInt(t.querySelector("#popupSize").value),popupOpacity:parseFloat(t.querySelector("#popupOpacity").value),popupDuration:parseInt(t.querySelector("#popupDuration").value),titleCooldownDisplay:t.querySelector("#titleCooldownDisplay").checked,titleAnswerDuration:parseInt(t.querySelector("#titleAnswerDuration").value),titleShowAnalyzing:t.querySelector("#titleShowAnalyzing").checked,buttonPosition:t.querySelector("#buttonPosition").value,buttonSize:parseInt(t.querySelector("#buttonSize").value),buttonOpacity:parseFloat(t.querySelector("#buttonOpacity").value),buttonIcon:t.querySelector("#buttonIcon").value,buttonSingleClick:t.querySelector("#buttonSingleClick").checked,buttonDoubleClick:t.querySelector("#buttonDoubleClick").checked,buttonTooltip:t.querySelector("#buttonTooltip").checked,historyLimit:Math.min(parseInt(t.querySelector("#historyLimit").value),15)},s=parseInt(t.querySelector("#historyLimit").value);s>15&&console.warn(`History limit adjusted from ${s} to 15 to prevent storage quota exceeded`);if(!(n.modelsAllowed||[]).includes(a.selectedModel))throw new Error("O modelo selecionado n√£o est√° dispon√≠vel no seu plano");if("total"===a.screenCaptureMode&&!checkPlanAccess(e,["pro","admin"]))throw new Error("Seu plano n√£o permite captura total");if(a.keybindProEnabled&&!checkPlanAccess(e,["pro","admin"]))throw new Error("Seu plano n√£o permite Keybind Pro");if(a.keybindSimple){if(!/^(Alt|Ctrl|Ctrl\+Alt)\+[A-Za-z0-9]$/.test(a.keybindSimple))throw new Error("Keybind simples inv√°lido. Use Alt+X, Ctrl+X ou Ctrl+Alt+X")}if(a.keybindCaptureModeSwitch){if(!/^Alt\+[A-Za-z0-9]$/.test(a.keybindCaptureModeSwitch))throw new Error("Keybind de modo de captura inv√°lido. Use apenas Alt+X (ex: Alt+C)")}if(a.buttonIcon){if(!/^fa-[a-z0-9-]+$/.test(a.buttonIcon))throw new Error("√çcone inv√°lido. Use o formato fa-nome-do-icone")}const i=await getStorageItem("token"),o=await fetch(`${API_BASE_URL}/users/me/configuration`,{method:"PATCH",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!o.ok){if(401===o.status)return await chrome.storage.local.clear(),void window.location.reload();const t=await o.json();throw new Error(t.error?.message||"Erro ao salvar configura√ß√µes")}await chrome.storage.local.set({settings:a}),currentUser.configurationSettings=a,await chrome.storage.local.set({user:currentUser}),console.log("Settings saved to user object and storage"),showToast("Configura√ß√µes salvas com sucesso!","success");const r=document.getElementById("settingsTab");r&&r.classList.contains("active")&&await loadSettings(r),chrome.tabs.query({},(t=>{t.forEach((t=>{chrome.tabs.sendMessage(t.id,{action:"reloadSettings"}).catch((()=>{}))}))}))}catch(t){showToast(t.message,"error")}finally{e.disabled=!1,e.innerHTML='<i class="fas fa-save"></i> Salvar Configura√ß√µes'}}function checkPlanAccess(t,e){return e.includes(t)}async function loadHistory(t){t.innerHTML='<div class="loading"><div class="spinner"></div></div>';try{const e=await getStorageItem("history")||[];if(0===e.length)return void(t.innerHTML='\n        <div class="empty-state">\n          <i class="fas fa-history"></i>\n          <h3>Nenhum hist√≥rico ainda</h3>\n          <p>Suas capturas e respostas aparecer√£o aqui</p>\n        </div>\n      ');t.innerHTML=`\n      <div class="history-container">\n        <div class="history-header">\n          <h3><i class="fas fa-history"></i> Hist√≥rico (${e.length} itens)</h3>\n          <button id="clearHistory" class="btn btn-danger btn-sm">\n            <i class="fas fa-trash"></i> Limpar Tudo\n          </button>\n        </div>\n        \n        <div class="history-list">\n          ${e.map((t=>createHistoryItem(t))).join("")}\n        </div>\n      </div>\n    `,setupHistoryHandlers(t)}catch(e){console.error("Load history error:",e),t.innerHTML='<div class="error-message show">Erro ao carregar hist√≥rico</div>'}}function createHistoryItem(t){const e=formatDate(new Date(t.timestamp)),n=t.modelId?`<span class="history-model">${t.modelId}</span>`:"";return`\n    <div class="history-item" data-timestamp="${t.timestamp}">\n      <div class="history-item-header">\n        <div class="history-date">\n          <i class="fas fa-clock"></i> ${e}\n        </div>\n        ${n}\n        <div class="history-actions">\n          <button class="icon-btn view-image" title="Ver Imagem">\n            <i class="fas fa-image"></i>\n          </button>\n          <button class="icon-btn copy-response" title="Copiar Resposta">\n            <i class="fas fa-copy"></i>\n          </button>\n          <button class="icon-btn delete-item" title="Excluir">\n            <i class="fas fa-trash"></i>\n          </button>\n        </div>\n      </div>\n      \n      <div class="history-response">\n        ${t.response}\n      </div>\n      \n      <img src="${t.image}" class="history-image" style="display: none;">\n    </div>\n  `}function setupHistoryHandlers(t){t.querySelector("#clearHistory")?.addEventListener("click",(async()=>{confirm("Tem certeza que deseja limpar todo o hist√≥rico?")&&(await chrome.storage.local.set({history:[]}),await loadHistory(t),showToast("Hist√≥rico limpo com sucesso","success"))})),t.querySelectorAll(".view-image").forEach((t=>{t.addEventListener("click",(e=>{const n=e.target.closest(".history-item").querySelector(".history-image");"none"===n.style.display?(n.style.display="block",t.innerHTML='<i class="fas fa-eye-slash"></i>',t.title="Ocultar Imagem"):(n.style.display="none",t.innerHTML='<i class="fas fa-image"></i>',t.title="Ver Imagem")}))})),t.querySelectorAll(".copy-response").forEach((t=>{t.addEventListener("click",(async e=>{const n=e.target.closest(".history-item").querySelector(".history-response").textContent;try{await navigator.clipboard.writeText(n),showToast("Resposta copiada!","success"),t.innerHTML='<i class="fas fa-check"></i>',setTimeout((()=>{t.innerHTML='<i class="fas fa-copy"></i>'}),2e3)}catch(t){showToast("Erro ao copiar","error")}}))})),t.querySelectorAll(".delete-item").forEach((e=>{e.addEventListener("click",(async e=>{const n=e.target.closest(".history-item"),a=parseInt(n.dataset.timestamp);if(confirm("Excluir este item do hist√≥rico?")){const e=(await getStorageItem("history")||[]).filter((t=>t.timestamp!==a));await chrome.storage.local.set({history:e}),await loadHistory(t),showToast("Item removido","success")}}))}))}function loadSupport(t){t.innerHTML='\n    <div class="support-section">\n      <h3>Precisa de Ajuda?</h3>\n      <p>Entre em contato conosco atrav√©s dos canais abaixo:</p>\n      <a href="mailto:support@sillymaquina.com" class="btn btn-primary">\n        <i class="fas fa-envelope"></i> Enviar Email\n      </a>\n      <a href="https://sillymaquina.netlify.app/support" target="_blank" class="btn">\n        <i class="fas fa-external-link-alt"></i> Acessar Suporte\n      </a>\n    </div>\n  '}function formatDate(t){return`${String(t.getDate()).padStart(2,"0")}/${String(t.getMonth()+1).padStart(2,"0")}/${t.getFullYear()} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}async function getStorageItem(t){return(await chrome.storage.local.get(t))[t]}function formatNumber(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".")}function getDefaultSettings(){return{selectedModel:"gemini-2.5-flash-lite",temperature:.9,screenCaptureMode:"padr√£o",keybindSimple:"Alt+X",keybindPro:null,keybindProEnabled:!1,keybindModelSwitch:null,keybindCaptureModeSwitch:null,answerExhibitionMode:"pageTitle",popupSize:300,popupOpacity:.95,popupDuration:10,titleCooldownDisplay:!0,titleAnswerDuration:15,titleShowAnalyzing:!0,buttonPosition:"bottomRight",buttonSize:50,buttonOpacity:.9,buttonIcon:"fa-robot",buttonSingleClick:!0,buttonDoubleClick:!0,buttonTooltip:!0,historyLimit:15}}function showToast(t,e="info"){const n=document.createElement("div");n.className=`toast toast-${e}`,n.textContent=t,n.style.cssText=`\n    position: fixed;\n    bottom: 20px;\n    right: 20px;\n    background: ${"success"===e?"#48bb78":"error"===e?"#f56565":"#667eea"};\n    color: white;\n    padding: 12px 20px;\n    border-radius: 6px;\n    z-index: 10000;\n    animation: slideInRight 0.3s ease-out;\n  `,document.body.appendChild(n),setTimeout((()=>{n.remove()}),3e3)}document.addEventListener("DOMContentLoaded",(async()=>{showLoadingScreen(),await checkMaintenanceAndAuth()})),document.getElementById("loginForm")?.addEventListener("submit",(async t=>{t.preventDefault();const e=document.getElementById("email").value,n=document.getElementById("password").value,a=t.target.querySelector('button[type="submit"]'),s=document.getElementById("loginError");a.disabled=!0,a.innerHTML='<i class="fas fa-spinner fa-spin"></i> Entrando...',s.classList.remove("show");try{const t=await fetch(`${API_BASE_URL}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:n})});if(!t.ok){const e=await t.json();throw new Error(e.error?.message||"Erro ao fazer login")}const a=await t.json();await chrome.storage.local.set({token:a.token,user:a.user}),window.location.reload()}catch(t){s.textContent=t.message,s.classList.add("show")}finally{a.disabled=!1,a.innerHTML='<i class="fas fa-sign-in-alt"></i> Entrar'}})),document.getElementById("logoutBtn")?.addEventListener("click",(async()=>{const t=await getStorageItem("token");try{await fetch(`${API_BASE_URL}/auth/logout`,{method:"POST",headers:{Authorization:`Bearer ${t}`}})}catch(t){}await chrome.storage.local.clear(),window.location.reload()})),document.getElementById("refreshMaintenanceBtn")?.addEventListener("click",(async()=>{window.location.reload()})),document.getElementById("bannerDetailsBtn")?.addEventListener("click",(()=>{maintenanceStatus&&maintenanceStatus.upcoming&&showMaintenanceModal(maintenanceStatus.upcoming)})),document.getElementById("closeMaintenanceModal")?.addEventListener("click",(()=>{document.getElementById("maintenanceModal").classList.add("hidden")})),document.getElementById("maintenanceModal")?.addEventListener("click",(t=>{"maintenanceModal"===t.target.id&&document.getElementById("maintenanceModal").classList.add("hidden")})),document.querySelectorAll(".nav-tab").forEach((t=>{t.addEventListener("click",(()=>{loadTab(t.dataset.tab)}))}));