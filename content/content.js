let settings=null,user=null,config=null,isProcessing=!1,cooldownInterval=null,currentButton=null,originalTitle="",titleTimeout=null,lastModelSwitchTime=0,cooldownTitleInterval=null,titleState="normal",titleLock=!1,extensionContextValid=!0,pageTitleStorage={};function checkExtensionContext(){try{return!!chrome.runtime?.id||(extensionContextValid=!1,!1)}catch(e){return extensionContextValid=!1,!1}}async function safeSendMessage(e){if(!checkExtensionContext())throw new Error("Extension foi atualizada. Por favor, recarregue a página.");try{return await chrome.runtime.sendMessage(e)}catch(e){if(e.message.includes("Extension context invalidated"))throw extensionContextValid=!1,new Error("Extension foi atualizada. Por favor, recarregue a página.");throw e}}function injectFontAwesome(){if(document.querySelector('link[href*="fontawesome"]'))return;const e=document.createElement("link");e.rel="stylesheet",e.href=chrome.runtime.getURL("lib/fontawesome-free-6.5.1-web/css/all.min.css"),document.head.appendChild(e)}function setupSPANavigationListener(){let e=location.href;chrome.storage.local.get(["pageTitleStorage"]).then((e=>{pageTitleStorage=e.pageTitleStorage?e.pageTitleStorage:{}}));const t=history.pushState,o=history.replaceState;history.pushState=function(...e){t.apply(this,e),a()},history.replaceState=function(...e){o.apply(this,e),a()},window.addEventListener("popstate",a),setInterval((()=>{location.href!==e&&(e=location.href,a())}),300);const n=new MutationObserver((()=>{if(("normal"===titleState||titleLock)&&"normal"===titleState){const e=document.title;e!==originalTitle&&(originalTitle=e)}})),i=document.querySelector("title");function a(){e=location.href;const t=getUrlKey(location.href);if("normal"!==titleState||titleLock){titleTimeout&&(clearTimeout(titleTimeout),titleTimeout=null),cooldownTitleInterval&&(clearInterval(cooldownTitleInterval),cooldownTitleInterval=null),titleLock=!1,titleState="normal";const e=pageTitleStorage[t];return void(e?(document.title=e,originalTitle=e):setTimeout((()=>{const e=document.title;!e||e.includes("⏳")||e.includes("Analisando")||e.includes("Resposta:")||e.includes("Inválida/Insolúvel")||e.includes("Erro:")||(originalTitle=e,pageTitleStorage[t]=e,savePageTitleStorage())}),300))}const o=pageTitleStorage[t];o?(document.title=o,originalTitle=o):setTimeout((()=>{const e=document.title;!e||e.includes("⏳")||e.includes("Analisando")||e.includes("Resposta:")||e.includes("Inválida/Insolúvel")||e.includes("Erro:")||(originalTitle=e,pageTitleStorage[t]=e,savePageTitleStorage())}),200)}i&&n.observe(i,{childList:!0,characterData:!0,subtree:!0})}function loadPageTitleStorage(){chrome.storage.local.get(["pageTitleStorage"]).then((e=>{pageTitleStorage=e.pageTitleStorage?e.pageTitleStorage:{}})).catch((e=>{console.error("Failed to load page title storage:",e),pageTitleStorage={}}))}function savePageTitleStorage(){const e=Object.keys(pageTitleStorage);if(e.length>50){e.slice(0,e.length-50).forEach((e=>delete pageTitleStorage[e]))}chrome.storage.local.set({pageTitleStorage:pageTitleStorage}).then((()=>{console.log("Saved domain title storage to chrome.storage")})).catch((e=>{console.error("Failed to save domain title storage:",e)}))}function getUrlKey(e){try{return new URL(e).origin}catch{return e}}function saveCurrentPageTitle(){const e=getUrlKey(location.href),t=document.title;t.includes("⏳")||t.includes("Analisando")||"normal"!==titleState||(pageTitleStorage[e]=t,originalTitle=t,savePageTitleStorage(),console.log("Saved domain title:",t,"for",e))}function removeFooterOnTargetSite(){if(window.location.href.startsWith("https://exams-sesi-avaliacao-2022.didatti.net.br/")){const e=()=>{try{const e=document.querySelector(".footer");e&&e.remove()}catch(e){console.error("Error removing footer:",e)}};e();const t=new MutationObserver((()=>{document.querySelector(".footer")&&e()}));document.body?t.observe(document.body,{childList:!0,subtree:!0}):document.addEventListener("DOMContentLoaded",(()=>{e(),t.observe(document.body,{childList:!0,subtree:!0})}))}}async function loadData(){const e=await chrome.storage.local.get(["settings","user","config"]);settings=e.user&&e.user.configurationSettings?mergeWithDefaults(e.user.configurationSettings):e.settings?mergeWithDefaults(e.settings):getDefaultSettings(),user=e.user,config=e.config,user&&config||console.warn("User or config not loaded yet"),await chrome.storage.local.set({settings:settings}),"undefined"!=typeof window&&(window.sillyMaquinaSettings=settings),console.log("Settings loaded:",{keybindProEnabled:settings.keybindProEnabled,keybindPro:settings.keybindPro,keybindSimple:settings.keybindSimple})}function mergeWithDefaults(e){return{...getDefaultSettings(),...e}}async function isAuthenticated(){try{return(await safeSendMessage({action:"checkAuth"})).isAuthenticated}catch(e){return console.error("Auth check failed:",e),!1}}function handleMessage(e,t,o){switch(e.action){case"triggerCapture":captureAndProcess();break;case"switchModel":switchModel();break;case"captureFullPage":return captureFullPage().then(o),!0;case"reloadSettings":loadData().then((()=>{currentButton&&createFloatingButton(),setupKeybinds()}));break;case"forceLogout":currentButton&&(currentButton.remove(),currentButton=null),displayError("Sessão expirada. Recarregue a página e faça login novamente.")}}function createFloatingButton(){if(!settings||"hidden"===settings.buttonPosition)return;const e=document.getElementById("sillymaquina-button");e&&e.remove();const t=document.createElement("div");t.id="sillymaquina-button",t.className="sillymaquina-button idle",t.innerHTML=`<i class="${settings.buttonIcon||"fa-solid fa-robot"}"></i>`,t.style.width=`${settings.buttonSize}px`,t.style.height=`${settings.buttonSize}px`,t.style.fontSize=.5*settings.buttonSize+"px",t.style.opacity=settings.buttonOpacity,"bottomRight"===settings.buttonPosition?(t.style.bottom="20px",t.style.right="20px"):"bottomLeft"===settings.buttonPosition&&(t.style.bottom="20px",t.style.left="20px");let o=null,n=0;if(t.addEventListener("click",(async()=>{n++,1===n?o=setTimeout((async()=>{if(settings.buttonSingleClick&&1===n){if(isProcessing||titleLock||"answer"===titleState||"analyzing"===titleState)return;try{const e=await safeSendMessage({action:"getCooldownStatus"});if(e&&e.success){const{canRequest:t,waitTime:o}=e.cooldown;if(!t&&o>0)return}}catch(e){console.error("Failed to check cooldown on button click:",e)}captureAndProcess()}n=0}),300):2===n&&(clearTimeout(o),settings.buttonDoubleClick&&switchModel(),n=0)})),settings.buttonTooltip){let e;t.addEventListener("mouseenter",(()=>{e=setTimeout((()=>{showTooltip(t)}),500)})),t.addEventListener("mouseleave",(()=>{clearTimeout(e),hideTooltip()}))}document.body.appendChild(t),currentButton=t,updateButtonState()}function updateButtonState(){currentButton&&(checkExtensionContext()?safeSendMessage({action:"getCooldownStatus"}).then((e=>{if(e&&e.success){const{canRequest:t,waitTime:o}=e.cooldown;isProcessing?(currentButton.className="sillymaquina-button processing",currentButton.innerHTML='<i class="fas fa-spinner"></i>',"cooldown"!==titleState||"analyzing"!==titleState&&"answer"!==titleState&&!titleLock||cooldownInterval&&(clearInterval(cooldownInterval),cooldownInterval=null)):!t&&o>0?(currentButton.className="sillymaquina-button cooldown",currentButton.textContent=o,"pageTitle"===settings.answerExhibitionMode&&settings.titleCooldownDisplay&&"answer"!==titleState&&"analyzing"!==titleState&&!titleLock&&showCooldownInTitle(o),cooldownInterval&&clearInterval(cooldownInterval),cooldownInterval=setInterval((()=>{updateButtonState()}),1e3)):"answer"===titleState||"analyzing"===titleState||titleLock?cooldownInterval||(cooldownInterval=setInterval((()=>{updateButtonState()}),1e3)):(currentButton.className="sillymaquina-button idle",currentButton.innerHTML=`<i class="${settings.buttonIcon||"fa-solid fa-robot"}"></i>`,"cooldown"===titleState&&restoreOriginalTitle(),cooldownInterval&&(clearInterval(cooldownInterval),cooldownInterval=null))}})).catch((e=>{console.error("Failed to get cooldown status:",e)})):currentButton&&(currentButton.className="sillymaquina-button error",currentButton.innerHTML='<i class="fas fa-exclamation-triangle"></i>',currentButton.title="Extension precisa ser recarregada"))}function showCooldownInTitle(e){if("answer"===titleState||titleLock)return;if(!originalTitle||"normal"===titleState){const e=getUrlKey(location.href);originalTitle=pageTitleStorage[e]||document.title}cooldownTitleInterval&&clearInterval(cooldownTitleInterval),titleState="cooldown";let t=e;document.title=`⏳ ${t}s | ${originalTitle}`,cooldownTitleInterval=setInterval((()=>{t--,t>0&&!titleLock?document.title=`⏳ ${t}s | ${originalTitle}`:(clearInterval(cooldownTitleInterval),cooldownTitleInterval=null,titleLock||restoreOriginalTitle())}),1e3)}function restoreOriginalTitle(){if("answer"===titleState||"analyzing"===titleState||titleLock)return;cooldownTitleInterval&&(clearInterval(cooldownTitleInterval),cooldownTitleInterval=null),titleTimeout&&(clearTimeout(titleTimeout),titleTimeout=null);const e=getUrlKey(location.href),t=pageTitleStorage[e]||originalTitle;t&&document.title!==t&&(document.title=t,originalTitle=t,titleState="normal")}function showTooltip(e){hideTooltip(),chrome.storage.local.get(["user","config","settings"],(t=>{const o=t.user,n=t.config,i=t.settings||settings;if(!o||!n)return;const a=document.createElement("div");a.id="sillymaquina-tooltip",a.className="sillymaquina-tooltip";const l=n.plans[o.plan.id];if(!l)return;const s=o.tokens.remaining,r=l.weeklyTokenAllocation,c=s/r*100,d=n.models[i.selectedModel];function u(){const t=e.getBoundingClientRect(),o=settings.buttonPosition,n=a.offsetHeight,i=t.top;"bottomRight"===o?(a.style.right=window.innerWidth-t.right+"px",i>n+10?(a.style.bottom=window.innerHeight-t.top+10+"px",a.style.top="auto"):(a.style.top=`${t.bottom+10}px`,a.style.bottom="auto")):"bottomLeft"===o&&(a.style.left=`${t.left}px`,i>n+10?(a.style.bottom=window.innerHeight-t.top+10+"px",a.style.top="auto"):(a.style.top=`${t.bottom+10}px`,a.style.bottom="auto"))}d&&(a.innerHTML=`\n\t    <div class="tooltip-label">Tokens Restantes</div>\n\t    <div class="tooltip-value">${formatNumber(s)} / ${formatNumber(r)}</div>\n\t    <div class="tokens-bar-mini">\n\t      <div class="tokens-progress-mini" style="width: ${c}%"></div>\n\t    </div>\n\t    <div class="model-info">\n\t      <div>\n\t        <div class="tooltip-label">Modelo Atual</div>\n\t        <div class="tooltip-value">${d.name}</div>\n\t      </div>\n\t      <div class="model-cost">\n\t        <i class="fas fa-coins"></i> ${formatNumber(d.tokenCost)}\n\t      </div>\n\t    </div>\n\t  `,document.body.appendChild(a),a._updatePosition=u,u(),window.addEventListener("scroll",u,{passive:!0}),window.addEventListener("resize",u,{passive:!0}),setTimeout((()=>{a.classList.add("show")}),10))}))}function hideTooltip(){const e=document.getElementById("sillymaquina-tooltip");e&&(e._updatePosition&&(window.removeEventListener("scroll",e._updatePosition),window.removeEventListener("resize",e._updatePosition)),e.remove())}function setupKeybinds(){window._keybindHandler&&document.removeEventListener("keydown",window._keybindHandler),window._mouseClickHandler&&document.removeEventListener("mousedown",window._mouseClickHandler,!0),window._auxClickHandler&&document.removeEventListener("auxclick",window._auxClickHandler,!0),window._keybindHandler=e=>{if(checkKeybind(e,settings.keybindProEnabled?settings.keybindPro:settings.keybindSimple)&&(e.preventDefault(),captureAndProcess()),settings.keybindModelSwitch&&checkKeybind(e,settings.keybindModelSwitch)){const t=Date.now();t-lastModelSwitchTime>=1e3&&(e.preventDefault(),switchModel(),lastModelSwitchTime=t)}settings.keybindCaptureModeSwitch&&checkKeybind(e,settings.keybindCaptureModeSwitch)&&(e.preventDefault(),switchCaptureMode())},window._mouseClickHandler=e=>{!settings?.keybindProEnabled||settings.keybindPro},document.addEventListener("keydown",window._keybindHandler),document.addEventListener("mousedown",window._mouseClickHandler,!0),window._auxClickHandler&&document.removeEventListener("auxclick",window._auxClickHandler,!0),window._auxClickHandler=e=>{if(1===e.button){if(settings&&settings.keybindProEnabled&&"MiddleMouse"===settings.keybindPro)return e.preventDefault(),e.stopPropagation(),captureAndProcess(),!1;console.log("Middle mouse clicked but not configured for capture")}},document.addEventListener("auxclick",window._auxClickHandler,!0)}function checkKeybind(e,t){if(!t)return!1;if(t.includes("+")){const o=t.split("+"),n=o.slice(0,-1),i=o[o.length-1];let a=!0;n.includes("Ctrl")&&!e.ctrlKey&&(a=!1),n.includes("Alt")&&!e.altKey&&(a=!1),n.includes("Shift")&&!e.shiftKey&&(a=!1);let l=e.key;return" "===l&&(l="Space"),1===l.length&&(l=l.toUpperCase()),a&&l.toLowerCase()===i.toLowerCase()}if(settings.keybindProEnabled){return["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","Enter","Space","Tab","Escape","Backspace","Delete","Home","End","PageUp","PageDown","Insert","Pause","Print"].includes(e.key)?e.key===t&&!e.ctrlKey&&!e.altKey&&!e.shiftKey:e.key.toLowerCase()===t.toLowerCase()&&!e.ctrlKey&&!e.altKey&&!e.shiftKey}return e.key.toLowerCase()===t.toLowerCase()&&!e.ctrlKey&&!e.altKey&&!e.shiftKey}async function captureAndProcess(){if(isProcessing)console.log("Already processing, blocking request");else if(titleLock||"answer"===titleState||"analyzing"===titleState)console.log("Still showing answer or analyzing, blocking request");else if(checkExtensionContext()){try{const e=await safeSendMessage({action:"checkMaintenance"});if(e&&e.isUnderMaintenance){return void displayError(`${e.active?.title||"Sistema em manutenção"}. Tente novamente mais tarde.`)}}catch(e){console.error("Failed to check maintenance status:",e)}try{const e=await safeSendMessage({action:"getCooldownStatus"});if(e&&e.success){const{canRequest:t,waitTime:o,cooldownSeconds:n}=e.cooldown;if(!t&&o>0)return console.warn(`Still in cooldown: ${o}s remaining (total: ${n}s)`),console.warn("Blocking request in content.js BEFORE sending to background.js"),void displayError(`⏳ Aguarde ${o}s antes de fazer nova solicitação`);console.log("Cooldown passed, proceeding with request")}}catch(e){console.error("Failed to check cooldown status:",e)}isProcessing=!0,updateButtonState(),saveCurrentPageTitle(),"pageTitle"===settings.answerExhibitionMode&&settings.titleShowAnalyzing&&setPageTitle("Analisando...",null,"analyzing");try{const e=await safeSendMessage({action:"captureScreen"});if(!e.success)throw new Error(e.error);const t=await safeSendMessage({action:"processImage",imageData:e.screenshot,modelId:settings.selectedModel});if(!t.success)throw new Error(t.error);console.log("API request successful, about to load data and display answer"),await loadData(),displayAnswer(t.result),currentButton&&(currentButton.className="sillymaquina-button success",setTimeout((()=>{updateButtonState()}),1e3))}catch(e){console.error("Capture/Process error:",e),isProcessing=!1,updateButtonState();let t=e.message;if(e.message&&(e.message.includes("Limite de requisições excedido")||e.message.includes("Aguarde")&&e.message.includes("segundos"))){const o=e.message.match(/(\d+)\s*segundo/),n=o?o[1]:"120";t=`⏳ Aguarde ${n}s antes de fazer nova solicitação`,console.warn(`Rate limited by server: ${n}s`)}displayError(t),currentButton&&(currentButton.className="sillymaquina-button error",setTimeout((()=>{updateButtonState()}),1e3))}}else displayError("Extension foi atualizada. Por favor, recarregue a página.")}async function captureFullPage(){return new Promise((async e=>{try{const t=await html2canvas(document.documentElement,{allowTaint:!0,useCORS:!0,backgroundColor:"#ffffff",scale:1,logging:!1,imageTimeout:5e3});e({success:!0,screenshot:t.toDataURL("image/png"),mode:"total"})}catch(t){console.error("Full page capture error:",t),e({success:!1,error:t.message})}}))}function hidePageHeaders(){const e=[],t=["header",".header","#header",".navbar",".nav","nav",".top-bar",".topbar","[role='banner']","[role='navigation']"],o=document.querySelectorAll("*");for(const o of t){document.querySelectorAll(o).forEach((t=>{const o=t.getBoundingClientRect(),n=window.getComputedStyle(t);("fixed"===n.position||"sticky"===n.position)&&o.top<200&&t.offsetHeight>0&&("none"!==n.display||"hidden"!==n.visibility)&&(e.push({element:t,display:t.style.display,visibility:t.style.visibility}),t.style.display="none",console.log(`Hiding header element: ${t.tagName}.${t.className}`))}))}return o.forEach((t=>{const o=t.className.toString().toLowerCase(),n=t.id.toString().toLowerCase();if((o.includes("header")||n.includes("header"))&&t.offsetHeight>0){if(t.getBoundingClientRect().top<300){const o=window.getComputedStyle(t);"fixed"!==o.position&&"sticky"!==o.position||"none"===o.display&&"hidden"===o.visibility||(e.push({element:t,display:t.style.display,visibility:t.style.visibility}),t.style.display="none",console.log(`Hiding header element: ${t.tagName}#${t.id}.${t.className}`))}}})),e}function restorePageHeaders(e){e.forEach((({element:e,display:t,visibility:o})=>{e.style.display=t,e.style.visibility=o,console.log(`Restored header element: ${e.tagName}`)}))}function displayAnswer(e){"smallPopup"===settings.answerExhibitionMode?showPopupAnswer(e):showTitleAnswer(e)}function showPopupAnswer(e){const t=document.createElement("div");t.className="sillymaquina-popup",t.style.width=`${settings.popupSize}px`,t.style.opacity=settings.popupOpacity,"bottomRight"===settings.buttonPosition?(t.style.bottom="80px",t.style.right="20px"):"bottomLeft"===settings.buttonPosition?(t.style.bottom="80px",t.style.left="20px"):(t.style.top="20px",t.style.right="20px"),t.innerHTML=`\n    <div class="popup-header">\n      <div class="popup-title">Resposta</div>\n      <div class="popup-close"><i class="fas fa-times"></i></div>\n    </div>\n    <div class="popup-content">${e}</div>\n    <div class="popup-footer">Clique para fechar</div>\n  `,t.addEventListener("click",(()=>{t.parentNode&&(t.remove(),updateButtonState())}));const o=t.querySelector(".popup-close");o&&o.addEventListener("click",(e=>{e.stopPropagation(),t.parentNode&&(t.remove(),updateButtonState())})),document.body.appendChild(t),settings.popupDuration>0&&setTimeout((()=>{t.parentNode&&(t.remove(),updateButtonState())}),1e3*settings.popupDuration)}function showTitleAnswer(e){setPageTitle(e,settings.titleAnswerDuration,"answer")}function setPageTitle(e,t=null,o="normal"){if(!titleLock||"answer"===o){if(cooldownTitleInterval&&(clearInterval(cooldownTitleInterval),cooldownTitleInterval=null),titleTimeout&&(clearTimeout(titleTimeout),titleTimeout=null),!originalTitle||"normal"===titleState){originalTitle=document.title;const e=getUrlKey(location.href);pageTitleStorage[e]||(pageTitleStorage[e]=originalTitle,savePageTitleStorage())}titleState=o,titleLock="answer"===o,document.title=e,t&&(titleTimeout=setTimeout((async()=>{if(titleLock=!1,titleState="normal",checkExtensionContext())try{const e=await safeSendMessage({action:"getCooldownStatus"});if(e&&e.success){const{canRequest:t,waitTime:o}=e.cooldown;if(!t&&o>0&&settings.titleCooldownDisplay)showCooldownInTitle(o);else{const e=getUrlKey(location.href),t=pageTitleStorage[e]||originalTitle;t&&document.title!==t&&(document.title=t),titleState="normal"}}else{const e=getUrlKey(location.href),t=pageTitleStorage[e]||originalTitle;t&&document.title!==t&&(document.title=t),titleState="normal"}}catch(e){console.error("Failed to get cooldown status:",e);const t=getUrlKey(location.href),o=pageTitleStorage[t]||originalTitle;o&&document.title!==o&&(document.title=o),titleState="normal"}else{const e=getUrlKey(location.href),t=pageTitleStorage[e]||originalTitle;t&&document.title!==t&&(document.title=t),titleState="normal"}}),1e3*t))}}function displayError(e){"smallPopup"===settings.answerExhibitionMode?showPopupAnswer(`Erro: ${e}`):setPageTitle(`Erro: ${e}`,5,"error")}function showAnalyzingOverlay(){if(document.getElementById("sillymaquina-analyzing"))return;const e=document.createElement("div");e.id="sillymaquina-analyzing",e.className="sillymaquina-analyzing",e.innerHTML='<i class="fas fa-spinner"></i> Analisando...',document.body.appendChild(e)}function hideAnalyzingOverlay(){const e=document.getElementById("sillymaquina-analyzing");e&&e.remove()}async function switchModel(){try{if(!user||!config)return console.error("User or config not loaded"),void displayError("Dados não carregados");const e=config.plans[user.plan.id];if(!e)return console.error("Plan config not found"),void displayError("Configuração do plano não encontrada");const t=e.modelsAllowed||Object.keys(config.models||{});if(!t||0===t.length)return console.error("No models available for user plan"),void displayError("Nenhum modelo disponível para o seu plano");let o=t.indexOf(settings.selectedModel);-1===o&&(o=0);const n=t[(o+1)%t.length];if(!config.models[n])return console.error("Model not found in config:",n),void displayError("Erro ao trocar modelo");settings.selectedModel=n,await chrome.storage.local.set({settings:settings}),user.configurationSettings&&(user.configurationSettings.selectedModel=n,await chrome.storage.local.set({user:user}));try{const e=await chrome.storage.local.get("token"),t=await fetch("https://sillymaquina.vercel.app/api/v1/users/me/configuration",{method:"PATCH",headers:{Authorization:`Bearer ${e.token}`,"Content-Type":"application/json"},body:JSON.stringify({selectedModel:n})});if(!t.ok){if(401===t.status)return await chrome.storage.local.clear(),displayError("Sessão expirada. Recarregue a página e faça login novamente."),void(currentButton&&(currentButton.remove(),currentButton=null));throw new Error("Failed to update model on server")}}catch(e){console.error("Failed to update model on server:",e)}showModelSwitchNotification(config.models[n].name),currentButton&&createFloatingButton()}catch(e){console.error("Model switch error:",e),displayError("Erro ao trocar modelo")}}function showModelSwitchNotification(e){if(document.querySelector(".sillymaquina-model-switch"))return;const t=document.createElement("div");t.className="sillymaquina-model-switch",t.innerHTML=`<i class="fas fa-exchange-alt"></i> Modelo: ${e}`,document.body.appendChild(t),setTimeout((()=>{t.parentNode&&t.remove()}),"pageTitle"===settings.answerExhibitionMode?500:2e3)}async function switchCaptureMode(){try{if(!user||"pro"!==user.plan.id&&"admin"!==user.plan.id)return void displayError("Trocar modo de captura está disponível apenas para usuários Pro");const e="padrão"===settings.screenCaptureMode?"total":"padrão";settings.screenCaptureMode=e,await chrome.storage.local.set({settings:settings}),user.configurationSettings&&(user.configurationSettings.screenCaptureMode=e,await chrome.storage.local.set({user:user}));try{const t=await chrome.storage.local.get("token"),o=await fetch("https://sillymaquina.vercel.app/api/v1/users/me/configuration",{method:"PATCH",headers:{Authorization:`Bearer ${t.token}`,"Content-Type":"application/json"},body:JSON.stringify({screenCaptureMode:e})});if(!o.ok){if(401===o.status)return await chrome.storage.local.clear(),displayError("Sessão expirada. Recarregue a página e faça login novamente."),void(currentButton&&(currentButton.remove(),currentButton=null));throw new Error("Failed to update capture mode on server")}}catch(e){console.error("Failed to update capture mode on server:",e)}showCaptureModeNotification(e)}catch(e){console.error("Capture mode switch error:",e),displayError("Erro ao trocar modo de captura")}}function showCaptureModeNotification(e){if(document.querySelector(".sillymaquina-capture-mode"))return;const t=document.createElement("div");t.className="sillymaquina-capture-mode",t.innerHTML='<i class="fas fa-camera"></i> Modo: '+("total"===e?"Total":"Padrão"),document.body.appendChild(t),setTimeout((()=>{t.parentNode&&t.remove()}),"pageTitle"===settings.answerExhibitionMode?500:2e3)}function formatNumber(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".")}function getDefaultSettings(){return{selectedModel:"gemini-2.5-flash-lite",temperature:.9,screenCaptureMode:"padrão",keybindSimple:"Alt+X",keybindPro:null,keybindProEnabled:!1,keybindModelSwitch:null,keybindCaptureModeSwitch:null,answerExhibitionMode:"pageTitle",popupSize:300,popupOpacity:.95,popupDuration:10,titleCooldownDisplay:!0,titleAnswerDuration:15,titleShowAnalyzing:!0,buttonPosition:"oculto",buttonSize:50,buttonOpacity:.9,buttonIcon:"fa-solid fa-robot",buttonSingleClick:!0,buttonDoubleClick:!0,buttonTooltip:!0,historyLimit:15}}!async function(){injectFontAwesome(),await loadData(),await isAuthenticated()&&(createFloatingButton(),setupKeybinds(),setupSPANavigationListener(),chrome.runtime.onMessage.addListener(handleMessage),window.sillyMaquinaSettings=settings),removeFooterOnTargetSite()}();